---
title: "Capstone Project"
author: "Erik Emilsson"
date: "20 December 2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(skimr)
library(janitor)
#library(reshape)#dataframe manipulation
```

*This project is part of the Google Data Analytics Certificate on Coursera and the dataset and the fictional problem comes from Track 1 How does a bike-share navigate speedy business. I am using R in R-markdown for data import, cleaning and visualization as well as the final reporting. R-markdown can do all these steps and having everything in one place keeps track of the assumptions and steps of the analysis for transparency and reporoducibilty.*

The project will be split up into three parts:
1. Business Task Background
2. Exploration and Cleaning
3. Data Visualization


# 1.Business Task Background
Cyclist is a bike/share program with over 5,800 bikes and 600 docking stations. Currently there are two types of riders: 

1) **casual riders** (those who buy single-ride or full-day passes), and 
2) **annual members a.k.a. Cyclistic members**. 

The goal is to *maximize the number of annual memberships for the company by converting more casual riders to annual members*. Lily Moreno (director of marketing) and the Cyclistic finance analysts have concluded that that annual members are more profitable than casual riders. Before this, Cyclistic have focused on building general awareness and appealing to broad consumer segments.

Currently 8 percent of riders use assistive options (e.g. reclining bikes, hand tricycles, and cargo bikes) while the rest use traditional bikes. Those who use traditional bikes are more likely to be casual riders, but about 30 percent of them use the service to commute to work each day.

Of the the following three questions that will guide the larger scope of the future marketing program, this report will only answer the first question:

* <mark>**How do annual members and casual riders use Cyclistic bikes differently?** </mark>
* Why would casual riders buy Cyclistic annual memberships?
* How can Cyclistic use digital media to influence casual riders to become annual members?

The stakeholders are:

* Lily Moreno, director of marketing and my manager,
* The Cyclistic marketing analytics team, a team of data analysts of which I am a part of. The team supports the Cyclistic marketing strategy with data. 
* The Cyclistic executive team the will decide if the recommended marketing program is approved.

# 2. Data Import

The dataset that will be used to answer the business task is Cycilstic's historical trip data for the previous 12 months. The dataset was downloaded in a zip file with a folder for each month, each containing data in CSV-format. The data ranges from 202110 to 202209, using ISO date notation (YYYYMMDD).

## Import data and append data
Import data from october 2021 to September 2022.
```{r Data Import, include=FALSE}
#read all the CSV files of trip data for the past 12 months as dataframes in R
df_202110 <- read_csv("202110-divvy-tripdata.csv")
df_202111 <- read_csv("202111-divvy-tripdata.csv")
df_202112 <- read_csv("202112-divvy-tripdata.csv")
df_202201 <- read_csv("202201-divvy-tripdata.csv")
df_202202 <- read_csv("202202-divvy-tripdata.csv")
df_202203 <- read_csv("202203-divvy-tripdata.csv")
df_202204 <- read_csv("202204-divvy-tripdata.csv")
df_202205 <- read_csv("202205-divvy-tripdata.csv")
df_202206 <- read_csv("202206-divvy-tripdata.csv")
df_202207 <- read_csv("202207-divvy-tripdata.csv")
df_202208 <- read_csv("202208-divvy-tripdata.csv")
df_202209 <- read_csv("202209-divvy-publictripdata.csv")

#append all months into single dataframe
df <- rbind(df_202110, df_202111,df_202112, df_202201, df_202202, df_202203, df_202204, df_202205, df_202206, df_202207, df_202208, df_202209)
```

# 3.Exploration and Cleaning

## First glance

```{r}
head(df)
```
The dataframe headers are in 13 columns, which contain information such as unique rider IDs, bike type, start & end times, locations and type of rider. At first glance the headers need to be changed to be more descriptive and there are some missing values in the station names and IDs.

## Rename headers

```{r}
df_renamed <- df %>% 
  rename(Ride_ID = ride_id) %>%
  rename(Bike_Type = rideable_type) %>%
  rename(Rider_Type = member_casual)
```

## Inspect Missing and Unique values

There are missing observations for some of the columns in the head. Skimr  more information about missing values and also unique values for each column.
```{r}
skim_without_charts(df_renamed)
```

### Unique observations:

* There are 5,828,235 observations (rows under the headers) and the exact same number of unique Ride_IDs, so Ride_IDs can be considered unique identifiers for each row.
* There are 3 unique values (n_unique) for Bike_Type and 2 unique values for Rider_Type.

The skim_without_charts function doesn't show the unique values of coordinates, so this is done here:

```{r message=FALSE}
df_renamed %>%
  group_by(Bike_Type, Rider_Type) %>%
  summarise("Start station latitudes" = n_distinct(start_lat), "Start station longitudes" = n_distinct(start_lng), "End station latitudes" = n_distinct(end_lat), "End station longitudes" = n_distinct(end_lng)) %>%
gather(Bike_Type, value, "Start station latitudes", "Start station longitudes", "End station latitudes", "End station longitudes") %>% #unpivots chart
  ggplot(mapping = aes(x = Rider_Type, y=value)) +
  geom_bar(stat = "identity") +
  facet_wrap(~Bike_Type) +
  labs(title="Count of unique values of geographical coordinates", x = "", y = "Unique instances")
```

* Start and end station names and IDs have about 1000-2000 unique values while their respective longitudes and latitudes have about 20000-60000 unique values. Due to the discrepancy it will not be possible to do a one-to-one match the coordinates with station name and ID. By looking at the missing data it should give some ideas as to which columns can be dropped for graphing location data.
* The unique values of all the locations are much greater than the "over 600 docking station" that were stated in the case study description. Start/End station ID come closest (1302 and 1309 unique values).

### Missing data:

* Between 15-17% of the data is missing for the start and end station names and IDs and the missing data for both is identical. Thus, choosing to omit either columns for name or ID should not have any effect on the missing data. I will remove names since IDs have a figure closer to the 600 docks from the case study description.
* There is no missing data for start coordinates, but ~0.1% of data is missing for the end coordinates.

There may be many reasons for why there's missing data, and I will speculate a bit here so I can explain my choice in cleaning. For instance, it could be that there the data wasn't transmitted properly due to bad connections. There might also be missing data because the bike was parked/thrown somewhere "unofficial" at the end of the ride. Whatever the case, the missing data will be of high importance and thus shouldn't be removed to be transparent and to be clear where more or better data collection is be needed for more granular insights into locations.

```{r}
df_nocoordinates <- df_renamed %>%
  replace_na(list(start_station_id = 'Missing location ID', end_station_id = 'Missing location ID')) %>%
  select(Ride_ID, Bike_Type, start_station_id, end_station_id, started_at, ended_at, Rider_Type)
```

Now the coordinates columns are gone but the observations have not been removed and hence the number of rows has not been changed.

## Calculate Travel Time
Now add another column that shows the total time the riders used the bikes for, buy taking the difference between 'started_at' and 'ended_at' and naming the new column header 'Trip_Time_Minutes'. Since the result will be expressed in seconds I will change it to minutes by dividing by 60. I will also change the data type to numeric so that it can be used in graphs. I'll change the title of the column to reflect these changes. And I will remove the columns that won't be used at the same time:

```{r}
df_nocoordinates2 <- df_nocoordinates %>%
  mutate(Trip_Time_Minutes = (ended_at - started_at)/60) %>%
  select(Ride_ID, Bike_Type, start_station_id, end_station_id, Trip_Time_Minutes, Rider_Type)

df_nocoordinates2$Trip_Time_Minutes <- as.numeric(df_nocoordinates2$Trip_Time_Minutes)

#round to nearest minute
df_nocoordinates2$Trip_Time_Minutes <- round(df_nocoordinates2$Trip_Time_Minutes, 0)

glimpse(df_nocoordinates2)
```
# 3.Data Analysis and Visualization

## Bike Type

Visualize the counts of rides by bike type and member/casual(non-member):
```{r Bike Type}
ggplot(data = df_nocoordinates2) +
  geom_bar(mapping = aes(x = Rider_Type)) +
  facet_wrap(~Bike_Type) +
  labs(title="Bike types used by type of rider", x = "", y = "Count of rides")
```
Some observations of the graph:
* There are more rides from members than rides by casual riders in total.
* Casual riders seem to prefer electric bikes over classic bikes while it is the opposite for members. However, the difference is not substantial.
* Classic bikes are used much more by members than by casual riders. Electric bikes are used about the same amount by members and casual riders.
* Docked bikes were not used at all by members.
* Docked bikes are used much less than any other type of bike.

Some questions that pop up from this first graph are:
* Why don't any annual members use docked bikes at all? Are docked bikes available in the areas where they would be used? What percentage of rides are using docked bikes?
* Why do casual riders prefer electric bikes and members prefer classic bikes?

```{r}
#percentage of riders using docked bikes
df_nocoordinates2 %>% 
  summarize(df_nocoordinates2,)

```

## Trip Time

To get a sense of how the times are scattered we can use a scatterplot:
```{r}
ggplot(data = df_nocoordinates2) +
  geom_point(mapping = aes(x = Trip_Time_Minutes, y = Bike_Type)) +
  facet_wrap(~Rider_Type) + 
  labs(title="Total time per ride", x = "Minutes", y = "") +
  theme_classic()
```
Docked bikes seem to include times that are much greater (0-40,000minutes) than electric and classic bikes (0-2,000minutes) in travel time. This should be investigated further. There also appears to be one or more datapoints that is/are less than 0 for members using electric bikes. These points need to be removed:
```{r}
paste("There are",sum(df_nocoordinates2$Trip_Time_Minutes < 0),"rows with trip times below 0 minutes.")

#remove observations with values of trip times below 0 minutes
df_nocoordinates3 <- df_nocoordinates2[df_nocoordinates2$Trip_Time_Minutes > 0, ]
  
glimpse(df_nocoordinates3)
```
To get some stats on the trip time I'll do some 
* Average travel time for each bike type and membership type
* Min max och each travel time for each bike type and membership type

```{r message=FALSE}
#percentage of riders using docked bikes
df_nocoordinates3 %>%
  group_by(Rider_Type, Bike_Type) %>%
  summarise(mean = mean(Trip_Time_Minutes), n= n()) %>% 
  mutate(Ride_time_in_years = mean*n/60/24/365) %>%
  ggplot(mapping = aes(x = Rider_Type, y = Ride_time_in_years)) +
  geom_bar(stat= "identity") +
  facet_wrap(~Bike_Type) +
  labs(title="Total Ride Time of All Riders", x = "", y = "Years")
```
This shows that although there aren't as many docked bikes as other types of bikes, the total annual ride time is in the same ballpark.

## Docked bike users

```{r}
df_nocoordinates3 %>%
  filter(Bike_Type=="docked_bike") %>%
  ggplot(aes(x=Trip_Time_Minutes)) + 
  geom_histogram(binwidth=1000) +
  labs(title = "Counts of trip times in minutes for docked bikes", x = "Trip times in minutes", y = "Occurances")
```

This histogram tells us that most of the rides are less than about 1000 minutes by a lot. However, there is not a 

Next I want to look specifically the riding behavior of the riders of docked bikes that ride for a "long" time, arbitrarily chosen to be over 2,000 minutes or about 33 hours, which is close to the maximum trip time for any other bike.

```{r}
df_nocoordinates3_dockedhigh <- df_nocoordinates3[df_nocoordinates3$Trip_Time_Minutes > 20000, ]

df_nocoordinates3_dockedhigh %>%
  filter(Bike_Type=="docked_bike") %>%
  ggplot(aes(start_station_id)) +
  geom_bar(aes(fill=start_station_id)) +
  coord_flip() +
  theme_classic()
```

```{r}
df_nocoordinates3_dockedhigh %>% 
  filter(Bike_Type=="docked_bike") %>%
  ggplot(aes(end_station_id)) +
  geom_bar(aes(fill=end_station_id)) +
  labs(title = "Docked bikes end stations", x = "", y = "") +
  coord_flip() +
  theme_classic()
```




```{r}
df_nocoordinates3 %>%
  filter(Bike_Type %in% c("electric bike","classic_bike")) %>%
  ggplot(aes(x=Trip_Time_Minutes, y=Bike_Type)) + facet_wrap(~ Trip_Time_Minutes)
```

It appears that the ride time doesn't seem to differ much between the members and casual riders for electric and classic bikes, although the range of times for the classic bikes is slightly greater than for electric bikes.

However, the docked bikes (which are only used by casual riders) have a a range of usage times that are much greater than either electric or classic bikes.

```{r}
ggplot(data = df_nocoordinates3, aes(x = Trip_Time_Minutes)) +
  facet_wrap(~Bike_Type) +
  geom_point() +
  labs(title="Total time per ride", x = "Minutes", y = "")
```

To get a better sense of the spread of the times are we can put the graph above into a boxplot. The 

```{r}
# https://ggplot2.tidyverse.org/reference/geom_density.html
ggplot(data = df_nocoordinates3, aes(Trip_Time_Minutes, after_stat(count)) +
  geom_density(position = "stack")
```



```{r group and summarize}
hotel_summary <- 
  hotel_bookings %>%
  group_by(hotel) %>%
  summarise(average_lead_time=mean(lead_time),
            min_lead_time=min(lead_time),
            max_lead_time=max(lead_time))
```


## Geographical Location (Starting location)


## Round Trips
Looking at the station names I notice that sometimes riders start and end at the same station. By using this information and comparing it with other data we might see a pattern in rider behavior. I'll add one more column to show when the start and end station is the same or not using Boolean logic:

```{r}
length(which(df_nocoordinates2$start_station_id == df_nocoordinates2$end_station_id))
```

## Missing Location data

```{r}
paste("There are", sum(df_nocoordinates3$start_station_id == "Missing location ID"), "mising start location IDs.")
paste("There are", sum(df_nocoordinates3$end_station_id == "Missing location ID"), "missing end location IDs.")
```

The missing data for location IDs appears to be spread evenly between start and end locations.

## Additionally I would also like to plot Member Type vs. Total rides this year, by counting the 

### Testing assumptions on the data
In the provided project description, the following figures were stated:
* Cyclistic have over 5800 bicycles and 600 docking stations
* The majority of bikers opt for traditional bikes; about 8 percent use assistive options.
* About 30% use bikes for work.

# Evaluation and concluding remarks

The lack of data on station names (of about 15%) and geographical coordinates (less than 1%) can mean that the results are skewed, especially if the lack of data for these observations are not spread evenly. For example, if there are specific stations that don't show the data, then there could be a significant difference from the reported and actual number of rides in that area.

Recommendations for further analysis:
* Look into why docked bike users aren't members. Like: why don't any annual members use docked bikes? Are memberships available for riders of docked bikes and/or are the riders aware of the memberships?
* See why some docked bike rides are up to 40,000minutes long (almost 10 days). These riders are likely more intersted in a membership because they're paying a lot for the rentals by only being casual riders.
* Collect data on the behavior of specific users as well, not only per ride. Tracking individuals can give more insight into how the users use the bikes.
* Look into why there is missing data and if there is more than one reason for the 15% that don't show up in station names & IDs.
* Why do casual riders prefer electric bikes and members prefer classic bikes? Perform a questionaire to capture what casual members are drawn to regarding electric bikes and if there is anything Cyclistic can do to make a membership more palatable from their answers.